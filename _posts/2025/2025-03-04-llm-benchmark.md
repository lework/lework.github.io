---
layout: post
title: '如何使用 LLM-Benchmark 工具压测你的大语言模型性能'
date: '2025-03-04 20:00'
category: ai
tags: ai llm
author: lework
---
* content
{:toc}

{% raw %}

在当今 AI 快速发展的时代，大语言模型(LLM)已经成为许多企业和开发者的核心技术。然而，当我们部署自己的 LLM 服务时，如何评估其性能表现？特别是在高并发场景下，模型的 token 输出速率、响应时间等指标至关重要。今天，我将为大家介绍一款强大的开源工具——LLM-Benchmark，它能帮助你全面评估 LLM 模型的性能表现。




## 为什么需要压测 LLM 模型？

在实际生产环境中，LLM 模型可能面临各种挑战：

- 高并发请求导致的性能下降
- 长文本生成时的延迟问题
- 不同并发级别下的稳定性表现
- 资源利用效率评估

通过压测，我们可以提前发现这些问题，优化模型部署方案，确保用户体验。

## LLM-Benchmark 工具简介

LLM-Benchmark 是一款专为大语言模型设计的性能测试工具，支持自动化压力测试和详细的性能报告生成。它的主要特点包括：

- 多阶段并发测试（从低并发逐步提升到高并发）
- 自动化测试数据收集和分析
- 详细的性能指标统计和可视化报告
- 支持短文本和长文本测试场景
- 灵活的配置选项

## 快速上手指南

### 1. 环境准备

首先，我们需要克隆项目代码并准备环境：

```bash
# 克隆代码仓库
git clone https://github.com/lework/llm-benchmark.git
cd llm-benchmark

# 安装依赖（需要Python 3.7+）
pip install openai rich numpy
```

### 2. 运行全套性能测试

如果你想对模型进行全面的性能评估，可以使用`run_benchmarks.py`脚本：

```bash
python run_benchmarks.py \
    --llm_url "http://your-llm-server" \
    --api_key "your-api-key" \
    --model "your-model-name" \
    --use_long_context
```

这个命令会自动执行一系列不同并发级别的测试，从 1 并发到 300 并发，全面评估模型在各种负载下的表现。

参数说明：

- `--llm_url`: 你的 LLM 服务器地址
- `--api_key`: API 密钥（如果需要）
- `--model`: 模型名称
- `--use_long_context`: 使用长文本测试模式（可选）

### 3. 运行单次并发测试

如果你只想测试特定并发级别下的性能，可以直接使用`llm_benchmark.py`：

```bash
python llm_benchmark.py \
    --llm_url "http://your-llm-server" \
    --api_key "your-api-key" \
    --model "your-model-name" \
    --num_requests 100 \
    --concurrency 10 \
    --output_tokens 50
```

参数说明：

- `--num_requests`: 总请求数
- `--concurrency`: 并发数
- `--output_tokens`: 输出 token 数限制
- `--request_timeout`: 请求超时时间(秒)，默认 60 秒
- `--output_format`: 输出格式(json/line)，默认 line

## 性能指标解读

LLM-Benchmark 提供了丰富的性能指标，帮助你全面了解模型性能：

1. **请求每秒(RPS)**: 每秒处理的请求数，反映系统整体吞吐能力
2. **平均延迟**: 请求的平均响应时间
3. **P99 延迟**: 99%请求的响应时间，反映极端情况下的性能表现
4. **Token 生成速率**: 每秒生成的 token 数量，是评估 LLM 性能的核心指标
5. **首 token 时间(TTFT)**: 从发送请求到收到第一个 token 的时间，反映模型的初始响应速度
6. **成功率**: 成功完成的请求百分比，反映系统稳定性

## 实战案例分析

假设我们部署了一个基于 DeepSeek 的 LLM 服务，现在需要评估其在不同并发下的性能表现。

运行全套测试后，我们得到了如下结果：

![性能测试报告示例](\assets\images\2025\image-20250220155605371.png)

从报告中我们可以看出：

1. 在低并发(1)情况下，模型的 Token 生成速率为 25.67 tokens/sec，响应迅速且稳定
2. 随着并发提升到 50，Token 生成速率大幅提升至 1256.89 tokens/sec，系统扩展性良好
3. 当并发达到 300 时，虽然整体吞吐量继续提升，但 P99 延迟明显增加，成功率略有下降
4. 首 token 时间(TTFT)随并发增加而增长，在高并发下需要特别关注

基于这些数据，我们可以得出结论：该模型在并发 100 左右时性能最佳，再提高并发可能导致用户体验下降。

## 优化建议

根据测试结果，我们可以采取以下措施优化 LLM 服务：

1. **合理设置并发限制**: 根据测试结果，设置适当的 API 并发限制，避免过载
2. **优化首 token 时间**: 考虑使用模型量化或 KV 缓存等技术减少首 token 延迟
3. **资源扩容**: 如果需要支持更高并发，考虑增加 GPU 资源或分布式部署
4. **请求队列管理**: 实现智能的请求排队机制，避免系统过载时请求丢失
5. **监控告警**: 基于测试结果设置合理的性能监控阈值，及时发现异常

## 总结

LLM-Benchmark 工具为我们提供了一种简单高效的方式来评估大语言模型的性能表现。通过系统化的压力测试，我们可以全面了解模型在不同负载下的行为特征，为优化部署方案提供数据支持。

无论你是刚开始部署自己的 LLM 服务，还是需要对现有服务进行性能调优，LLM-Benchmark 都是一个不可或缺的工具。它不仅帮助你发现潜在的性能瓶颈，还能为你的优化决策提供可靠依据。

希望这篇文章对你有所帮助！如果你有任何问题或经验分享，欢迎在评论区留言交流。

{% endraw %}
